<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werewolf</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h3>ゲームに参加ボタン</h3>
  <button id="entry">参加</button>
  <h3 id='entryResult'>結果</h3>
  <ul id='gameHistory'></ul>
  <script src="/socket.io/socket.io.js"></script>  
  <script>
    /* 準備フェーズ **********************/
    /* ゲームに参加 */
    let entryState = 'no attempt';
    // すでに参加した人が一度しか参加ボタンを押せないようにする
    document.getElementById('entry').addEventListener('click', entryGame);
    function entryGame() {      
      if (entryState !== 'no attempt') return;
      fetch('/entry')
        .then(res => res.json())
        .then(data => {             
          entryState = data.entryResult;
          const entryOutput = document.getElementById('entryResult');

          if (entryState === 'accepted') {
            console.log('entry accepted');            
            entryOutput.innerHTML += ': 参加できました';            
            initializeSocket(data.room);
          } else if (entryState === 'denied') {
            console.log('entry denied');            
            entryOutput.innerHTML += ': 定員オーバー！あとで参加してください';
          }
      });    
    }

    const gameHistory = document.getElementById('gameHistory');

    function createHistory(content) {
      const li = document.createElement('li');
      li.appendChild(document.createTextNode(content));
      gameHistory.appendChild(li);
    }

    function renderPlayers(players) {      
      const describe = document.createElement('li');
      describe.appendChild(document.createTextNode('以下は参加者'));
      gameHistory.appendChild(describe);
      const form = document.createElement('form');
      for (let [id, state] of Object.entries(players)) {
        const radio = document.createElement('input');
        radio.setAttribute('type', 'radio');
        radio.setAttribute('name', 'vote');        
        radio.setAttribute('value', id);        
        form.appendChild(radio);

        const label = document.createElement('label');
        label.append(document.createTextNode(id));
        form.appendChild(label);
      }
      const li = document.createElement('li');
      li.appendChild(form);
      gameHistory.appendChild(li);
    }

    function renderNextButton(nextStep) {
      const button = document.createElement('button');
      button.appendChild(document.createTextNode('次へ進む'));
      button.addEventListener('click', (e) => {
        socket.emit(nextStep);
        button.disabled = true;
      });
      const li = document.createElement('li');
      li.appendChild(button);
      gameHistory.appendChild(li);
    }

    let socket;
    function initializeSocket(gameRoom) {
      socket = io('/'+gameRoom); 

      socket.on('preparePhaseGroup', (group, players) => {
        // あなたのグループはooです
        const content = 'あなたの役職は'+group+'です';
        createHistory(content);
        renderPlayers(players);
        renderNextButton('preparePhaseGroupEnd');
      });

      /* 昼フェーズ **********************/
      socket.on('dayPhaseDebate', () => {
        // 話し合う
      });
      socket.on('dayPhaseVoting', () => {
        // 処刑する人を選択
      });
      socket.on('dayPhaseLynch', () => {
        // 処刑結果
      });

      /* 夜フェーズ **********************/
      socket.on('nightPhase', () => {
        // 殺害する人を選んでください
      });
      socket.on('dayPhaseKill', () => {
        // ooが殺害されました
      });

      /* 結果フェーズ **********************/
      socket.on('resultPhase', () => {
        // 残りoo人になりました
        // ooの勝利
      });
    }
  </script>
</body>
</html>