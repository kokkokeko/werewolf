<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werewolf</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h3>ゲームに参加ボタン</h3>
  <button id="entry">参加</button>
  <h3 id='entryResult'>結果</h3>
  <ul id='gameHistory'></ul>
  <script src="/socket.io/socket.io.js"></script>  
  <script>
    /* 準備フェーズ **********************/
    /* ゲームに参加 */
    let entryState = 'no attempt';
    // すでに参加した人が一度しか参加ボタンを押せないようにする
    document.getElementById('entry').addEventListener('click', entryGame);
    function entryGame() {      
      if (entryState !== 'no attempt') return;
      fetch('/entry')
        .then(res => res.json())
        .then(data => {             
          entryState = data.entryResult;
          const entryOutput = document.getElementById('entryResult');

          if (entryState === 'accepted') {
            console.log('entry accepted');            
            entryOutput.innerHTML += ': 参加できました';            
            initializeSocket(data.room);
          } else if (entryState === 'denied') {
            console.log('entry denied');            
            entryOutput.innerHTML += ': 定員オーバー！あとで参加してください';
          }
      });    
    }

    const gameHistory = document.getElementById('gameHistory');

    function createHistory(content) {
      const li = document.createElement('li');
      li.appendChild(document.createTextNode(content));
      gameHistory.appendChild(li);
    }

    function renderPlayers(players) {      
      const describe = document.createElement('li');
      describe.appendChild(document.createTextNode('以下は参加者'));
      gameHistory.appendChild(describe);
      const form = document.createElement('form');
      for (let [id, state] of Object.entries(players)) {
        const radio = document.createElement('input');
        radio.setAttribute('type', 'radio');
        radio.setAttribute('name', 'vote');        
        radio.setAttribute('value', id);        
        form.appendChild(radio);

        const label = document.createElement('label');
        label.append(document.createTextNode(id));
        form.appendChild(label);
      }
      const li = document.createElement('li');
      li.appendChild(form);
      gameHistory.appendChild(li);
    }

    function renderNextButton(nextStep) {
      // nextStepは次のイベントを表す
      const button = document.createElement('button');
      button.appendChild(document.createTextNode('次へ進む'));
      button.addEventListener('click', (e) => {
        console.log('renderNextButton: ', nextStep);
        socket.emit(nextStep);
        button.disabled = true;
      });
      const li = document.createElement('li');
      li.appendChild(button);
      gameHistory.appendChild(li);
    }

    function renderVoting(players) {
      // 説明文
      const describe = document.createElement('li');
      describe.appendChild(document.createTextNode('以下は参加者'));  
      gameHistory.appendChild(describe);

      // radio formを作成
      const form = document.createElement('form');
      for (let [id, state] of Object.entries(players)) {
        const radio = document.createElement('input');
        radio.setAttribute('type', 'radio');
        radio.setAttribute('name', 'vote');
        radio.setAttribute('value', id);     
        form.appendChild(radio);

        const label = document.createElement('label');
        label.append(document.createTextNode(id));
        form.appendChild(label);
      }

      // 投票ボタン
      const button = document.createElement('button');
      button.appendChild(document.createTextNode('投票'));

      // 投票をサーバに送る
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('renderVoting submit');
        console.log(form);
        console.log(new FormData(form));
        const data = new FormData(form);
        for (const entry of data) {
          socket.emit('dayPhaseVotingEnd', entry[1]);
        }
        button.disabled = true;
      });
  
      // gameHistoryに追加
      form.appendChild(button);
      const li = document.createElement('li');
      li.appendChild(form);
      gameHistory.appendChild(li);
    }

    function renderVotingResult(voting, id) {
      createHistory('結果は以下の通りです');
      for (let [id, count] of Object.entries(voting)) {
        createHistory(`${id} さんは${count}票`);
      }
      if (id === 'nolynch') {
        // 処刑されなかった
        createHistory('同数票がいるため処刑は行われませんでした');
      } else {
        // ooが処刑された
        createHistory('投票の結果、'+id+' さんが処刑されました');
      }
    }

    let socket;
    function initializeSocket(gameRoom) {
      socket = io('/'+gameRoom); 

      socket.on('preparePhaseGroup', (group, players) => {
        // あなたのグループはooです
        const content = 'あなたの役職は'+group+'です';
        createHistory(content);
        renderPlayers(players);
        renderNextButton('preparePhaseGroupEnd');
      });

      /* 昼フェーズ **********************/
      socket.on('dayPhaseDebate', () => {
        // 話し合う
        createHistory('話し合ってください');
        renderNextButton('dayPhaseDebateEnd');
      });
      socket.on('dayPhaseVoting', (players) => {
        // 処刑する人を選択
        console.log('dayPhaseVoting');
        createHistory('処刑する人を選んでください');
        renderVoting(players);
      });
      socket.on('dayPhaseLynch', (id, voting) => {
        // 処刑結果
        console.log('dayPhaseLynch');
        console.log('voting result', voting);
        console.log('id: ', id);
        renderVotingResult(voting, id);
        renderNextButton('dayPhaseLynchEnd');
      });

      /* 夜フェーズ **********************/
      socket.on('nightPhasePickTarget', (players) => {
        // 殺害する人を選んでください
        console.log('nightPhasePickTarget');

      });
      socket.on('dayPhaseKill', () => {
        // ooが殺害されました
      });

      /* 結果フェーズ **********************/
      socket.on('resultPhase', () => {
        // 残りoo人になりました
        // ooの勝利
      });
    }
  </script>
</body>
</html>